<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Faucets</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/nosdav-shim.js"></script>
    <script type="module">
      import {
        html,
        render,
        Component
      } from 'https://unpkg.com/htm/preact/standalone.module.js'
      import * as secp256k1 from 'https://cdn.jsdelivr.net/npm/@noble/secp256k1@1.7.1/+esm'
      import * as bech32Library from 'https://cdn.jsdelivr.net/npm/bech32@2.0.0/+esm'
      import { Navbar } from './components/Navbar.js'

      // Make secp256k1 and bech32 available globally
      window.secp256k1 = secp256k1
      window.bech32 = bech32Library

      class App extends Component {
        constructor() {
          super()
          this.state = {
            loggedIn: false,
            publicKey: '',
            taprootAddress: '',
            navbarLoaded: false // Add this new state variable
          }
        }

        async componentDidMount() {
          // Create a promise that resolves after a delay
          const delay = ms => new Promise(resolve => setTimeout(resolve, ms))

          // Wait for the delay
          await delay(10)
          this.setState({ navbarLoaded: true })

          // Check if the user was previously logged in
          this.handleLogin()
        }

        generateTaprootAddress = async () => {
          try {
            let publicKey
            console.log('generateTaprootAddress')

            const privateKey = localStorage.getItem('nostr:privkey')
            if (privateKey) {
              console.log('Using private key from localStorage')
              // Convert private key to public key
              const privateKeyBytes = secp256k1.utils.hexToBytes(privateKey)
              publicKey = secp256k1.utils.bytesToHex(
                secp256k1.getPublicKey(privateKeyBytes, true)
              )
              publicKey = publicKey.slice(2)
            } else if (window.nostr) {
              console.log('Using window.nostr.getPublicKey()')
              // Get the public key from the extension
              let pubkey = await window.nostr.getPublicKey()
              publicKey = pubkey
              localStorage.setItem('nostr:pubkey', pubkey)
              localStorage.setItem('loggedIn', true)
              this.setState({ loggedIn: true, publicKey: publicKey })
            } else {
              throw new Error('No private key or Nostr extension found')
            }
            console.log('publicKey', publicKey)

            // Use the helper function to generate the Taproot address
            const taprootAddress = this.pubkeyToTaprootAddress(publicKey)

            console.log('Taproot address:', taprootAddress)

            this.setState({ publicKey, taprootAddress })
          } catch (error) {
            console.error('Error generating Taproot address:', error)
            Swal.fire(
              'Error',
              'Failed to generate Taproot address: ' + error.message,
              'error'
            )
          }
        }

        pubkeyToTaprootAddress = pubkey => {
          try {
            // Convert hex public key to bytes
            const pubkeyBytes = secp256k1.utils.hexToBytes(pubkey)

            // Convert public key to Bitcoin format (remove the first byte)
            const bitcoinPubKeyBytes = pubkeyBytes.slice(0)

            // Calculate Taproot address
            const taproot_prefix = 'tb' // Use 'bc' for mainnet
            const scriptVersion = 1
            const words = bech32Library.bech32.toWords(bitcoinPubKeyBytes)
            const taprootWords = [scriptVersion, ...words]
            const taprootAddress = bech32Library.bech32m.encode(
              taproot_prefix,
              taprootWords,
              1024
            )

            return taprootAddress
          } catch (error) {
            console.error('Error generating Taproot address:', error)
            throw error
          }
        }

        handleLogin = async () => {
          console.log('handleLogin')
          try {
            if (localStorage.getItem('nostr:privkey')) {
              // Use the private key from localStorage
              localStorage.setItem('loggedIn', 'true')
              this.setState({ loggedIn: true }, () => {
                this.generateTaprootAddress()
              })
            } else if (window.nostr) {
              const pubkey = await window.nostr.getPublicKey()
              localStorage.setItem('nostr:pubkey', pubkey)
              localStorage.setItem('loggedIn', 'true')
              this.setState({ loggedIn: true, publicKey: pubkey }, () => {
                this.generateTaprootAddress()
              })
            } else {
              // Existing login logic for non-extension login
              localStorage.setItem('loggedIn', 'true')
              this.setState({ loggedIn: true }, () => {
                this.generateTaprootAddress()
              })
            }
          } catch (error) {
            console.error('Login error:', error)
            Swal.fire('Error', 'Failed to log in: ' + error.message, 'error')
          }
        }

        handleLogout = () => {
          localStorage.removeItem('loggedIn')
          this.setState({ loggedIn: false, publicKey: '', taprootAddress: '' })
        }

        copyToClipboard = publicKey => {
          navigator.clipboard.writeText(publicKey)
          Swal.fire('Copied', 'Taproot address copied to clipboard', 'success')
        }

        render() {
          const { loggedIn, publicKey, taprootAddress, navbarLoaded } =
            this.state

          if (!navbarLoaded) {
            return html`<div>Loading...</div>` // Or any loading indicator you prefer
          }

          return html`
            <div class="app">
              <${Navbar}
                onLogout=${this.handleLogout}
                onLogin=${this.handleLogin}
                publicKey=${publicKey}
              />
              <main>
                <h1>Welcome to Faucets</h1>
                ${!loggedIn
                  ? html` <p>Click the login button to access your account.</p>`
                  : html`
                      <h2>Your Bitcoin Public Key</h2>
                      <p class="public-key">
                        <a
                          href="https://mempool.space/testnet4/address/${taprootAddress}"
                          target="_blank"
                          rel="noopener noreferrer"
                        >
                          ${taprootAddress.slice(0, 32)}...
                        </a>
                        <br />
                        <button
                          onClick=${() => this.copyToClipboard(taprootAddress)}
                        >
                          Copy Address
                        </button>
                      </p>
                      <h2>Testnet4 Faucets</h2>
                      <ul>
                        <li>
                          <a
                            href="https://coinfaucet.eu/en/btc-testnet4/"
                            target="_blank"
                            rel="noopener noreferrer"
                            >Coinfaucet</a
                          >
                        </li>
                        <li>
                          <a
                            href="https://testnet4.anyone.eu.org/"
                            target="_blank"
                            rel="noopener noreferrer"
                            >Anyone</a
                          >
                        </li>
                        <li>
                          <a
                            href="https://mempool.space/testnet4/faucet"
                            target="_blank"
                            rel="noopener noreferrer"
                            >Mempool Faucet</a
                          >
                        </li>
                      </ul>
                      <p>
                        Use these faucets to request testnet coins for
                        development and testing purposes. You can use your
                        Taproot address above to receive funds.
                      </p>
                    `}
              </main>
            </div>
          `
        }
      }

      render(html`<${App} />`, document.body)
    </script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body></body>
</html>
